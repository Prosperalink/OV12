#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Starting comprehensive quality checks..."

# Documentation organization rule check
echo "ğŸ“‹ Checking documentation organization..."
npm run check-docs

# If documentation check fails, prevent commit
if [ $? -ne 0 ]; then
  echo "âŒ Documentation organization rule violations found!"
  echo "Please fix the violations before committing."
  echo "Run 'npm run check-docs' to see the violations."
  exit 1
fi

echo "âœ… Documentation organization check passed!"

# TypeScript type checking
echo "ğŸ” Running TypeScript type checking..."
npm run type-check

if [ $? -ne 0 ]; then
  echo "âŒ TypeScript type checking failed!"
  echo "Please fix type errors before committing."
  exit 1
fi

echo "âœ… TypeScript type checking passed!"

# ESLint strict checking
echo "ğŸ” Running ESLint strict checking..."
npm run lint:strict

if [ $? -ne 0 ]; then
  echo "âŒ ESLint strict checking failed!"
  echo "Please fix linting errors before committing."
  echo "Run 'npm run lint:fix' to auto-fix some issues."
  exit 1
fi

echo "âœ… ESLint strict checking passed!"

# Prettier format checking
echo "ğŸ” Checking code formatting..."
npm run format:check

if [ $? -ne 0 ]; then
  echo "âŒ Code formatting check failed!"
  echo "Please format your code before committing."
  echo "Run 'npm run format' to auto-format code."
  exit 1
fi

echo "âœ… Code formatting check passed!"

# Security audit
echo "ğŸ” Running security audit..."
npm audit --audit-level=moderate

if [ $? -ne 0 ]; then
  echo "âš ï¸  Security vulnerabilities found!"
  echo "Please review and fix security issues before committing."
  echo "Run 'npm audit fix' to auto-fix some issues."
  # Don't exit here, just warn
fi

echo "âœ… Security audit completed!"

# Test coverage check (if tests exist)
if [ -f "jest.config.js" ]; then
  echo "ğŸ” Running tests..."
  npm run test:ci

  if [ $? -ne 0 ]; then
    echo "âŒ Tests failed!"
    echo "Please fix failing tests before committing."
    exit 1
  fi

  echo "âœ… Tests passed!"
fi

# Performance check
echo "ğŸ” Checking for performance issues..."
npm run performance

if [ $? -ne 0 ]; then
  echo "âš ï¸  Performance issues detected!"
  echo "Please review performance warnings."
  # Don't exit here, just warn
fi

echo "âœ… Performance check completed!"

# Auto-fix what can be fixed
echo "ğŸ”§ Auto-fixing issues..."
npm run lint:fix
npm run format

echo "âœ… All quality checks passed!"
echo "ğŸš€ Ready to commit!"
